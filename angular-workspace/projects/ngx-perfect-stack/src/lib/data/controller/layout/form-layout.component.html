<ng-container *ngIf="cells$ | async as cells">

  <!-- If template has a binding to the form -->
  <ng-container *ngIf="template && template.binding">
    <div [formGroup]="formGroup">
      <div class="row" *ngFor="let row of cells">
        <div [class]="getCSS(cell)" class="mt-3" *ngFor="let cell of row">
          <ng-container *ngIf="cell.attribute && cell.attribute.type !== AttributeType.OneToPoly">
            <lib-label [mode]="mode" [cell]="cell" [metaEntity]="metaEntity" [attribute]="cell.attribute"></lib-label>
          </ng-container>
          <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>

          <!--<ng-container *ngIf="cell.tool">
            <lib-tool-view [tool]="cell.tool"></lib-tool-view>
          </ng-container>-->

          <!-- If the cell has it's own template then we recursively nest the template inside of the cell. Which means
           we need to pass down the formGroup of the cell and name of the property for that formGroup -->
          <ng-container *ngIf="cell.template && cell.template.binding">
            <lib-layout [ctx]="ctx" [template]="cell.template" [formGroup]="formGroup" [relationshipProperty]="cell.template.binding"></lib-layout>
          </ng-container>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- If this template doesn't have a binding (normally this means it's a root level template with nested child templates, so no binding means no form group) -->
  <ng-container *ngIf="template && !template.binding">
    <div [formGroup]="formGroup">
      <div class="row" *ngFor="let row of cells">
        <div [class]="getCSS(cell)" *ngFor="let cell of row">
          <ng-container *ngIf="cell.template">
            <div class="p-3 bg-light shadow-sm border" *ngIf="cell.template">
              <lib-layout [ctx]="ctx" [template]="cell.template"></lib-layout>
            </div>
          </ng-container>

          <ng-container *ngIf="cell.attribute">
            <ng-container *ngIf="cell.attribute">
              <lib-label [mode]="mode" [cell]="cell" [metaEntity]="metaEntity" [attribute]="cell.attribute"></lib-label>
            </ng-container>
            <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>
          </ng-container>

          <!-- TODO: there's probably a tool one here, and in fact these have probably evolved into being just one block (same as above) -->
        </div>
      </div>
    </div>
  </ng-container>

</ng-container>
