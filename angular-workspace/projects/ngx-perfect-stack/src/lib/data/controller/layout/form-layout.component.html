<ng-container *ngIf="cells$ | async as cells">

  <!-- If template has a binding to the form -->
  <ng-container *ngIf="template && template.binding">
    <div class="py-3" [ngClass]="template.styles" [formGroup]="formGroup">
      <div class="row px-3" [ngClass]="{'form-row': isFormRow(row)}" *ngFor="let row of cells">
        <div [class]="getCSS(cell)" *ngFor="let cell of row">

          <ng-container *ngIf="cell && isShowLabel(cell)">
            <ng-container *ngIf="isShowLabelTop(cell)">
              <ng-container *ngIf="cell.attribute">
                <lib-label [mode]="mode" [cell]="cell" [metaEntity]="metaEntity" [attribute]="cell.attribute"></lib-label>
              </ng-container>
              <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>
            </ng-container>

            <ng-container *ngIf="isShowLabelLeft(cell)">
              <div class="row">
                <div class="col-4">
                  <ng-container *ngIf="cell.attribute">
                    <lib-label [mode]="mode" [cell]="cell" [metaEntity]="metaEntity" [attribute]="cell.attribute"></lib-label>
                  </ng-container>
                </div>
                <div class="col-8">
                  <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>
                </div>
              </div>
            </ng-container>

            <ng-container *ngIf="!isShowLabelLeft(cell) && !isShowLabelTop(cell)">
              Unknown Label Layout
            </ng-container>
          </ng-container>

          <ng-container *ngIf="cell && !isShowLabel(cell)">
            <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>
          </ng-container>

          <div *ngIf="mode === 'edit' && cell.footerHtml" [innerHtml]="cell.footerHtml"></div>

          <!-- this got moved into the Cell -->
          <!--<ng-container *ngIf="cell.tool">
            <lib-tool-view [tool]="cell.tool"></lib-tool-view>
          </ng-container>-->

          <!-- If the cell has it's own template then we recursively nest the template inside of the cell. Which means
           we need to pass down the formGroup of the cell and name of the property for that formGroup -->
          <ng-container *ngIf="cell.template && cell.template.binding">
            <lib-layout [ctx]="ctx" [template]="cell.template" [formGroup]="formGroup" [relationshipProperty]="cell.template.binding"></lib-layout>
          </ng-container>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- If this template doesn't have a binding (normally this means it's a root level template with nested child templates, so no binding means no form group) -->
  <ng-container *ngIf="template && !template.binding">
    <div [formGroup]="formGroup">
      <div [ngClass]="template.styles">  <!-- NO Binding means NO formGroup -->
        <div class="row" [ngClass]="{'form-row': isFormRow(row)}" *ngFor="let row of cells">
          <div [class]="getCSS(cell)" *ngFor="let cell of row">

            <ng-container *ngIf="cell.template">
              <div class="bg-light shadow-sm border" *ngIf="cell.template">
                <lib-layout [ctx]="ctx" [template]="cell.template"></lib-layout>
              </div>
            </ng-container>

            <ng-container *ngIf="cell.attribute && isShowLabel(cell)">
              <lib-label [mode]="mode" [cell]="cell" [metaEntity]="metaEntity" [attribute]="cell.attribute"></lib-label>
            </ng-container>

            <lib-cell [mode]="mode" [ctx]="ctx" [cell]="cell" [formGroup]="formGroup"></lib-cell>

            <!-- TODO: there's probably a tool one here, and in fact these have probably evolved into being just one block (same as above) -->
          </div>
        </div>
      </div>
    </div>
  </ng-container>

</ng-container>
